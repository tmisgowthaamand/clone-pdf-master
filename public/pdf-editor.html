<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit PDF - iLovePDF Clone</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
        }
        
        /* Top Toolbar - iLovePDF Style */
        #toolbar {
            background: white;
            border-bottom: 1px solid #ddd;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 55px;
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .toolbar-separator {
            width: 1px;
            height: 28px;
            background: #e0e0e0;
            margin: 0 8px;
        }
        
        .toolbar-btn {
            height: 32px;
            min-width: 32px;
            padding: 0 10px;
            border: 1px solid transparent;
            background: transparent;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            gap: 5px;
            white-space: nowrap;
            transition: all 0.15s;
            color: #333;
        }
        .toolbar-btn:hover {
            background: #e5e5e5;
            border-color: #adadad;
        }
        .toolbar-btn.active {
            background: #cce4f7;
            border-color: #0078d4;
            color: #0078d4;
        }
        
        select, input[type="number"] {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        .format-btn {
            width: 36px;
            height: 36px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .format-btn:hover {
            background: #f5f5f5;
            border-color: #bbb;
        }
        .format-btn.active {
            background: #333;
            color: white;
            border-color: #333;
        }
        #back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        #back-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(108,117,125,0.3);
        }
        
        #download-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin-left: auto;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        #download-btn:hover {
            background: #218838;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(40,167,69,0.3);
        }
        
        /* Page Thumbnails */
        #page-thumbnails {
            position: fixed;
            left: 70px;
            top: 55px;
            width: 200px;
            height: calc(100vh - 55px);
            background: white;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
            padding: 15px 10px;
            z-index: 40;
        }
        .page-thumb {
            margin-bottom: 15px;
            cursor: pointer;
            border-left: 4px solid transparent;
            border-radius: 4px;
            overflow: hidden;
            background: white;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .page-thumb:hover {
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
            transform: translateX(2px);
        }
        .page-thumb.active {
            border-left-color: #e74c3c;
            background: #fff5f5;
            box-shadow: 0 3px 8px rgba(231,76,60,0.3);
        }
        .page-thumb canvas {
            width: 100%;
            display: block;
        }
        .page-thumb-label {
            text-align: center;
            padding: 10px;
            font-size: 13px;
            font-weight: 500;
            color: #333;
            background: #f9f9f9;
        }
        
        /* Sidebar */
        #sidebar {
            position: fixed;
            left: 0;
            top: 55px;
            width: 70px;
            height: calc(100vh - 55px);
            background: white;
            box-shadow: 2px 0 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            padding-top: 10px;
            z-index: 50;
            border-right: 1px solid #e0e0e0;
        }
        .sidebar-tool {
            width: 100%;
            padding: 14px 0;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px;
            color: #666;
            font-size: 10px;
            transition: all 0.2s;
            position: relative;
            border-left: 3px solid transparent;
            min-height: 65px;
        }
        .sidebar-tool:hover {
            background: #f8f9fa;
        }
        .sidebar-tool.active {
            color: #e74c3c;
            border-left-color: #e74c3c;
            background: #fff5f5;
        }
        .sidebar-tool .icon {
            font-size: 32px;
            line-height: 1;
            margin-bottom: 3px;
        }
        .sidebar-tool .label {
            font-size: 10px;
            font-weight: 500;
            text-align: center;
            line-height: 1.2;
        }
        
        /* Canvas container */
        #canvas-container {
            position: fixed;
            left: 270px;
            top: 55px;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            background: #f5f5f5;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .page-wrapper {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            margin-bottom: 20px;
        }
        
        .page-number {
            position: absolute;
            top: -25px;
            left: 0;
            font-size: 12px;
            color: #999;
            font-weight: 500;
        }
        
        canvas {
            display: block;
            cursor: crosshair;
        }
    </style>
</head>
<body>
    <div id="page-thumbnails"></div>
    
    <div id="toolbar">
        <button id="back-btn" onclick="goBack()"><span>‚Üê</span> Back</button>
        <div class="toolbar-separator"></div>
        <button class="toolbar-btn" onclick="undo()" title="Undo">‚Ü∂</button>
        <button class="toolbar-btn" onclick="redo()" title="Redo">‚Ü∑</button>
        <div class="toolbar-separator"></div>
        <button class="toolbar-btn" onclick="setTool('text')" title="Add Text">T</button>
        <select id="font-select" style="height:36px;padding:0 12px;border:1px solid #ddd;border-radius:5px;font-size:14px;min-width:140px;">
            <option>Arial</option>
            <option>Courier New</option>
            <option>Georgia</option>
            <option>Times New Roman</option>
            <option>Verdana</option>
        </select>
        <button class="toolbar-btn" onclick="increaseFontSize()" title="Increase Font Size">T‚Üë</button>
        <input type="number" id="font-size" value="17" min="8" max="100" style="width:55px;height:36px;padding:0 10px;border:1px solid #ddd;border-radius:5px;font-size:14px;text-align:center;">
        <div class="toolbar-separator"></div>
        <button class="format-btn" onclick="toggleBold()" title="Bold">B</button>
        <button class="format-btn" onclick="toggleItalic()" title="Italic">I</button>
        <button class="format-btn" onclick="toggleUnderline()" title="Underline">U</button>
        <div class="toolbar-separator"></div>
        <button class="toolbar-btn" onclick="clearText()" title="Clear Selected Text">
            <span style="font-size:16px;">üßπ</span> Clear
        </button>
        <button class="toolbar-btn" onclick="clearAllObjects()" title="Clear All Objects">
            <span style="font-size:16px;">üóëÔ∏è</span> Clear All
        </button>
        <div class="toolbar-separator"></div>
        <input type="range" id="zoom-slider" min="25" max="200" value="100" style="width:120px;height:6px;" oninput="updateZoom(this.value)">
        <span id="zoom-display" style="font-size:14px;color:#666;min-width:50px;font-weight:500;">100%</span>
        <button id="download-btn" onclick="downloadPDF()"><span>üíæ</span> Download PDF</button>
    </div>
    
    <div id="sidebar">
        <button class="sidebar-tool active" onclick="setTool('select')" id="tool-select">
            <div class="icon">üëÜ</div>
            <div class="label">Select</div>
        </button>
        <button class="sidebar-tool" onclick="setTool('text')" id="tool-text">
            <div class="icon">üìù</div>
            <div class="label">Text</div>
        </button>
        <button class="sidebar-tool" onclick="setTool('image')" id="tool-image">
            <div class="icon">üñºÔ∏è</div>
            <div class="label">Image</div>
        </button>
        <button class="sidebar-tool" onclick="setTool('draw')" id="tool-draw">
            <div class="icon">‚úèÔ∏è</div>
            <div class="label">Draw</div>
        </button>
        <button class="sidebar-tool" onclick="setTool('shapes')" id="tool-shapes">
            <div class="icon">‚ñ≠</div>
            <div class="label">Shapes</div>
        </button>
        <button class="sidebar-tool" onclick="setTool('circle')" id="tool-circle">
            <div class="icon">‚≠ï</div>
            <div class="label">Circle</div>
        </button>
        <button class="sidebar-tool" onclick="setTool('line')" id="tool-line">
            <div class="icon">üìè</div>
            <div class="label">Line</div>
        </button>
        <button class="sidebar-tool" onclick="setTool('highlight')" id="tool-highlight">
            <div class="icon">üñçÔ∏è</div>
            <div class="label">Highlight</div>
        </button>
        <button class="sidebar-tool" onclick="setTool('eraser')" id="tool-eraser">
            <div class="icon">üßπ</div>
            <div class="label">Eraser</div>
        </button>
        <button class="sidebar-tool" onclick="setTool('signature')" id="tool-signature">
            <div class="icon">‚úçÔ∏è</div>
            <div class="label">Signature</div>
        </button>
        <button class="sidebar-tool" onclick="setTool('stamp')" id="tool-stamp">
            <div class="icon">üè¢</div>
            <div class="label">Stamp</div>
        </button>
        <button class="sidebar-tool" onclick="deleteSelected()">
            <div class="icon">üóëÔ∏è</div>
            <div class="label">Delete</div>
        </button>
    </div>
    
    <div id="canvas-container"></div>
    <input type="file" id="image-input" accept="image/*" style="display:none;">
    <input type="file" id="signature-input" accept="image/*" style="display:none;">
    <input type="file" id="stamp-input" accept="image/*" style="display:none;">

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        let pdfDoc = null;
        let fabrics = [];
        let currentTool = 'select';
        let currentColor = '#000000';
        let currentSize = 20;
        let currentFilename = 'document.pdf';
        
        // Listen for PDF data from parent
        window.addEventListener('message', function(event) {
            if (event.data.type === 'LOAD_PDF') {
                currentFilename = event.data.filename;
                loadPDF(event.data.pdfData);
            }
        });
        
        // Back button function
        function goBack() {
            console.log('Back button clicked');
            console.log('Is in iframe:', window.parent !== window);
            if (window.parent !== window) {
                // If in iframe, send message to parent
                console.log('Sending GO_BACK message to parent');
                window.parent.postMessage({ type: 'GO_BACK' }, '*');
            } else {
                // If standalone, go back in history
                console.log('Going back in history');
                window.history.back();
            }
        }
        
        function loadPDF(base64Data) {
            const pdfData = 'data:application/pdf;base64,' + base64Data;
            
            pdfjsLib.getDocument(pdfData).promise.then(pdf => {
                pdfDoc = pdf;
                
                // Render thumbnails
                for (let i = 1; i <= pdf.numPages; i++) {
                    pdf.getPage(i).then(page => {
                        const scale = 0.25;
                        const viewport = page.getViewport({ scale });
                        const canvas = document.createElement('canvas');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        
                        const thumbDiv = document.createElement('div');
                        thumbDiv.className = 'page-thumb' + (i === 1 ? ' active' : '');
                        thumbDiv.setAttribute('data-page', i - 1);
                        thumbDiv.onclick = function() { scrollToPage(this.getAttribute('data-page')); };
                        
                        const label = document.createElement('div');
                        label.className = 'page-thumb-label';
                        label.textContent = i;
                        
                        thumbDiv.appendChild(canvas);
                        thumbDiv.appendChild(label);
                        document.getElementById('page-thumbnails').appendChild(thumbDiv);
                        
                        page.render({ canvasContext: canvas.getContext('2d'), viewport });
                    });
                }
                
                // Render full pages
                for (let i = 1; i <= pdf.numPages; i++) {
                    renderPage(i);
                }
            });
        }
        
        function renderPage(pageNum) {
            pdfDoc.getPage(pageNum).then(page => {
                const scale = 1.5;
                const viewport = page.getViewport({ scale });
                
                const wrapper = document.createElement('div');
                wrapper.className = 'page-wrapper';
                wrapper.style.width = viewport.width + 'px';
                wrapper.style.height = viewport.height + 'px';
                
                const pageLabel = document.createElement('div');
                pageLabel.className = 'page-number';
                pageLabel.textContent = `Page ${pageNum} of ${pdfDoc.numPages}`;
                wrapper.appendChild(pageLabel);
                
                const pdfCanvas = document.createElement('canvas');
                pdfCanvas.width = viewport.width;
                pdfCanvas.height = viewport.height;
                pdfCanvas.style.position = 'absolute';
                
                const fabricCanvas = document.createElement('canvas');
                fabricCanvas.id = 'fabric-' + pageNum;
                fabricCanvas.width = viewport.width;
                fabricCanvas.height = viewport.height;
                fabricCanvas.style.position = 'absolute';
                
                wrapper.appendChild(pdfCanvas);
                wrapper.appendChild(fabricCanvas);
                document.getElementById('canvas-container').appendChild(wrapper);
                
                page.render({ canvasContext: pdfCanvas.getContext('2d'), viewport }).promise.then(() => {
                    const fabric = new window.fabric.Canvas(fabricCanvas.id);
                    fabric.freeDrawingBrush.color = currentColor;
                    fabric.freeDrawingBrush.width = 3;
                    fabrics.push({ canvas: fabric, pdfCanvas: pdfCanvas });
                    
                    fabric.on('mouse:down', function(e) {
                        handleCanvasClick(fabric, e);
                    });
                });
            });
        }
        
        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.sidebar-tool').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.getElementById('tool-' + tool);
            if (activeBtn) activeBtn.classList.add('active');
            
            fabrics.forEach(f => {
                f.canvas.isDrawingMode = (tool === 'draw');
                f.canvas.selection = (tool === 'select' || tool === 'eraser');
                
                // Enable eraser mode - clicking objects will delete them
                if (tool === 'eraser') {
                    f.canvas.hoverCursor = 'not-allowed';
                    f.canvas.defaultCursor = 'not-allowed';
                } else {
                    f.canvas.hoverCursor = 'move';
                    f.canvas.defaultCursor = tool === 'draw' ? 'crosshair' : 'default';
                }
            });
            
            if (tool === 'image') {
                document.getElementById('image-input').click();
            }
            
            if (tool === 'signature') {
                document.getElementById('signature-input').click();
            }
            
            if (tool === 'stamp') {
                document.getElementById('stamp-input').click();
            }
        }
        
        function handleCanvasClick(fabric, e) {
            const pointer = fabric.getPointer(e.e);
            
            // Eraser mode - delete clicked object
            if (currentTool === 'eraser') {
                const target = fabric.findTarget(e.e);
                if (target) {
                    fabric.remove(target);
                    fabric.renderAll();
                }
                return;
            }
            
            if (currentTool === 'text') {
                const textObj = new window.fabric.IText('Click to edit', {
                    left: pointer.x,
                    top: pointer.y,
                    fontSize: currentSize,
                    fill: currentColor,
                    fontFamily: 'Arial',
                    editable: true
                });
                fabric.add(textObj);
                fabric.setActiveObject(textObj);
                textObj.enterEditing();
                textObj.selectAll();
            } else if (currentTool === 'shapes') {
                const rect = new window.fabric.Rect({
                    left: pointer.x,
                    top: pointer.y,
                    width: 100,
                    height: 60,
                    fill: 'transparent',
                    stroke: currentColor,
                    strokeWidth: 2
                });
                fabric.add(rect);
            } else if (currentTool === 'circle') {
                const circle = new window.fabric.Circle({
                    left: pointer.x,
                    top: pointer.y,
                    radius: 40,
                    fill: 'transparent',
                    stroke: currentColor,
                    strokeWidth: 2
                });
                fabric.add(circle);
            } else if (currentTool === 'line') {
                const line = new window.fabric.Line([pointer.x, pointer.y, pointer.x + 100, pointer.y], {
                    stroke: currentColor,
                    strokeWidth: 3
                });
                fabric.add(line);
            } else if (currentTool === 'highlight') {
                const highlight = new window.fabric.Rect({
                    left: pointer.x,
                    top: pointer.y,
                    width: 150,
                    height: 20,
                    fill: 'rgba(255, 255, 0, 0.4)'
                });
                fabric.add(highlight);
            }
        }
        
        document.getElementById('image-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    window.fabric.Image.fromURL(event.target.result, function(img) {
                        img.scaleToWidth(200);
                        fabrics[0].canvas.add(img);
                    });
                };
                reader.readAsDataURL(file);
            }
        });
        
        function deleteSelected() {
            fabrics.forEach(f => {
                const active = f.canvas.getActiveObject();
                if (active) f.canvas.remove(active);
            });
        }
        
        function clearText() {
            fabrics.forEach(f => {
                const active = f.canvas.getActiveObject();
                if (active && (active.type === 'i-text' || active.type === 'text' || active.type === 'textbox')) {
                    active.set('text', '');
                    f.canvas.renderAll();
                }
            });
        }
        
        function clearAllObjects() {
            if (confirm('Are you sure you want to clear all annotations from all pages? This cannot be undone.')) {
                fabrics.forEach(f => {
                    f.canvas.clear();
                    f.canvas.backgroundColor = 'transparent';
                    f.canvas.renderAll();
                });
            }
        }
        
        function toggleBold() {
            fabrics.forEach(f => {
                const active = f.canvas.getActiveObject();
                if (active && active.type === 'i-text') {
                    active.set('fontWeight', active.fontWeight === 'bold' ? 'normal' : 'bold');
                    f.canvas.renderAll();
                }
            });
        }
        
        function toggleItalic() {
            fabrics.forEach(f => {
                const active = f.canvas.getActiveObject();
                if (active && active.type === 'i-text') {
                    active.set('fontStyle', active.fontStyle === 'italic' ? 'normal' : 'italic');
                    f.canvas.renderAll();
                }
            });
        }
        
        function toggleUnderline() {
            fabrics.forEach(f => {
                const active = f.canvas.getActiveObject();
                if (active && active.type === 'i-text') {
                    active.set('underline', !active.underline);
                    f.canvas.renderAll();
                }
            });
        }
        
        function increaseFontSize() {
            const sizeInput = document.getElementById('font-size');
            const currentSize = parseInt(sizeInput.value);
            sizeInput.value = currentSize + 2;
            updateFontSize();
        }
        
        function updateFontSize() {
            const size = parseInt(document.getElementById('font-size').value);
            fabrics.forEach(f => {
                const active = f.canvas.getActiveObject();
                if (active && active.type === 'i-text') {
                    active.set('fontSize', size);
                    f.canvas.renderAll();
                }
            });
        }
        
        function updateZoom(value) {
            document.getElementById('zoom-display').textContent = value + '%';
            const scale = value / 100;
            fabrics.forEach(f => {
                f.canvas.setZoom(scale);
                f.canvas.renderAll();
            });
        }
        
        function undo() {
            fabrics.forEach(f => {
                if (f.canvas._objects.length > 0) {
                    const lastObj = f.canvas._objects[f.canvas._objects.length - 1];
                    f.canvas.remove(lastObj);
                    f.canvas.renderAll();
                }
            });
        }
        
        function redo() {
            console.log('Redo functionality');
        }
        
        function scrollToPage(pageIndex) {
            const idx = parseInt(pageIndex);
            const pageElements = document.querySelectorAll('.page-wrapper');
            
            if (pageElements[idx]) {
                pageElements[idx].scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                document.querySelectorAll('.page-thumb').forEach((thumb, i) => {
                    thumb.classList.toggle('active', i === idx);
                });
            }
        }
        
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'px',
                format: [fabrics[0].pdfCanvas.width, fabrics[0].pdfCanvas.height]
            });
            
            fabrics.forEach((item, index) => {
                if (index > 0) pdf.addPage([item.pdfCanvas.width, item.pdfCanvas.height]);
                pdf.addImage(item.pdfCanvas.toDataURL(), 'PNG', 0, 0, item.pdfCanvas.width, item.pdfCanvas.height);
                pdf.addImage(item.canvas.toDataURL(), 'PNG', 0, 0, item.pdfCanvas.width, item.pdfCanvas.height);
            });
            
            pdf.save(currentFilename.replace('.pdf', '-edited.pdf'));
        }
        
        document.getElementById('font-select').addEventListener('change', function() {
            const font = this.value;
            fabrics.forEach(f => {
                const active = f.canvas.getActiveObject();
                if (active && active.type === 'i-text') {
                    active.set('fontFamily', font);
                    f.canvas.renderAll();
                }
            });
        });
        
        document.getElementById('font-size').addEventListener('change', updateFontSize);
    </script>
</body>
</html>
